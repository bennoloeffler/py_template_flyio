#!/bin/bash

set -e

echo "ğŸš€ Setting up Fly.io databases for {{ project_name }}"

KEBAB="{{ project_name }}"

TEST_CLUSTER_NAME="$KEBAB-cluster-test"
REGION="fra"
VM_SIZE="shared-cpu-1x"
TEST_APP="$KEBAB-test"




echo "ğŸ“¦ Creating Postgres TEST cluster: $TEST_CLUSTER_NAME"
fly pg create --name "$TEST_CLUSTER_NAME" --region "$REGION" --vm-size "$VM_SIZE"

echo "ğŸ”— Attaching postgres TEST cluster to app $TEST_APP"
if fly secrets list -a "$TEST_APP" | grep -q "DATABASE_URL"; then
  echo "ğŸ”’ Test app already has DATABASE_URL secret set. DELETING IT..."
  fly secrets unset DATABASE_URL -a "$TEST_APP"
  echo "ğŸ”’ DELETED"
fi
echo "ğŸ”— Attaching..."
fly pg attach "$TEST_CLUSTER_NAME" -a "$TEST_APP"
echo "RE-DEPLOYING to use the new DATABASE_URL..."
fly deploy -c fly.toml
echo "âœ… Test database setup complete!"  
echo ""
echo "ğŸ” To verify test databases:"
echo "  fly pg db list -a $TEST_CLUSTER_NAME"
