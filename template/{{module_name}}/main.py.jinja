from datetime import datetime
from typing import Any, Dict

from fastapi import FastAPI, Request
from fastapi.middleware.cors import CORSMiddleware
from fastapi.templating import Jinja2Templates
from slowapi import Limiter
from slowapi.errors import RateLimitExceeded
from slowapi.util import get_remote_address
from starlette.responses import Response

from {{ module_name }}.config import settings

# Initialize templates
templates = Jinja2Templates(directory="{{ module_name }}/html_templates")

# Initialize rate limiter
limiter = Limiter(key_func=get_remote_address)

# Create FastAPI app with configuration from settings
app = FastAPI(
    title=settings.app_title,
    version=settings.app_version,
    description="...",
    debug=settings.debug,
)

# Add security headers and CORS middleware
app.add_middleware(
    CORSMiddleware,
    allow_origins=settings.allowed_origins,
    allow_credentials=True,
    allow_methods=["GET", "POST", "PUT", "DELETE"],
    allow_headers=["*"],
)

# Add rate limiter middleware
app.state.limiter = limiter


@app.exception_handler(RateLimitExceeded)
async def rate_limit_handler(request: Request, exc: RateLimitExceeded) -> Response:
    """Handle rate limit exceeded exceptions."""
    return Response("Rate limit exceeded", status_code=429)


@app.get("/")
def root(request: Request) -> Any:
    """Returns a styled HTML landing page."""
    context = {
        "title": settings.app_title,
        "description": "...",
        "environment": settings.environment,
        "version": settings.app_version,
        "features": [
            {
                "icon": "âš¡",
                "name": "FastAPI",
                "description": "Modern, fast Python web framework",
            },
            {
                "icon": "ðŸ”’",
                "name": "Security",
                "description": "Rate limiting, CORS, security headers",
            },
            {
                "icon": "ðŸ“Š",
                "name": "Monitoring",
                "description": "Health checks and metrics",
            },
            {
                "icon": "ðŸš€",
                "name": "Production Ready",
                "description": "Docker and Fly.io deployment",
            },
        ],
        "api_links": [
            {"icon": "ðŸ“š", "name": "API Docs", "url": "/docs"},
            {"icon": "ðŸ¥", "name": "Health", "url": "/health"},
            {"icon": "ðŸ‘‹", "name": "Hello", "url": "/hello"},
            {"icon": "ðŸ•", "name": "Time", "url": "/time"},
        ],
    }
    return templates.TemplateResponse("index.html", {"request": request, **context})


@app.get("/hello")
@limiter.limit("60/minute")
def hello_world(request: Request) -> Dict[str, str]:
    """Returns a hello world message."""
    return {"message": "Hello from {{ project_name }}!"}


@app.get("/time")
@limiter.limit("30/minute")
def get_time(request: Request) -> Dict[str, str]:
    """Returns the current server time in ISO format."""
    return {"time": datetime.now().isoformat()}


@app.get("/health")
@limiter.limit("10/minute")
def health_check(request: Request) -> Dict[str, Any]:
    """Health check endpoint for monitoring."""
    return {
        "status": "healthy",
        "timestamp": datetime.now().isoformat(),
        "version": settings.app_version,
        "environment": settings.environment,
    }


def main() -> None:
    """Main entry point for the FastAPI application."""
    import uvicorn

    uvicorn.run(
        "{{ module_name }}.main:app",
        host=settings.host,
        port=settings.port,
        reload=settings.debug,
        workers=1 if settings.debug else settings.workers,
    )


if __name__ == "__main__":
    main()

