{% extends "base.html" %}

{% block title %}Files - {{ project_name }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-6xl">
    <h2 class="text-3xl font-bold text-gray-800 mb-6">Files</h2>

    <div class="flex flex-col md:flex-row gap-4 mb-6 items-start md:items-center">
        <input type="text" id="searchInput" placeholder="Search files..." class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        <label class="flex items-center space-x-2 text-gray-700 whitespace-nowrap">
            <input type="checkbox" id="myFilesOnly" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 focus:ring-2">
            <span>My files only</span>
        </label>
    </div>

    <div id="files-list" class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
        <div class="text-center py-8 text-gray-500">Loading files...</div>
    </div>

    <div class="pagination flex justify-center gap-2 mt-6" id="pagination"></div>
</div>

<style>
    .files-container {
        max-width: 1200px;
        margin: 2rem auto;
        padding: 2rem;
    }

    .filters {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
        align-items: center;
    }

    .search-input {
        flex: 1;
        padding: 0.75rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 1rem;
    }

    .files-list {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        overflow: hidden;
    }

    .file-item {
        display: flex;
        align-items: center;
        padding: 1rem;
        border-bottom: 1px solid #eee;
        transition: background 0.2s;
    }

    .file-item:hover {
        background: #f8f9fa;
    }

    .file-preview {
        width: 80px;
        height: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f8f9fa;
        border-radius: 4px;
        overflow: hidden;
        margin-right: 1rem;
    }

    .file-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.2s;
    }

    .file-preview img:hover {
        transform: scale(1.05);
    }

    .pdf-icon {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100%;
    }

    .file-info {
        flex: 1;
    }

    .file-name {
        font-weight: 500;
        color: #333;
        margin-bottom: 0.25rem;
    }

    .file-meta {
        font-size: 0.875rem;
        color: #666;
    }

    .file-actions {
        display: flex;
        gap: 0.5rem;
    }

    .btn-small {
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
    }

    .btn-copy {
        background: #007bff;
        color: white;
    }

    .btn-copy:hover {
        background: #0056b3;
    }

    .btn-download {
        background: #4CAF50;
        color: white;
    }

    .btn-download:hover {
        background: #45a049;
    }

    .btn-delete {
        background: #dc3545;
        color: white;
    }

    .btn-delete:hover {
        background: #c82333;
    }

    .loading {
        text-align: center;
        padding: 2rem;
        color: #666;
    }

    .pagination {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        margin-top: 2rem;
    }

    .pagination button {
        padding: 0.5rem 1rem;
        border: 1px solid #ddd;
        background: white;
        cursor: pointer;
        border-radius: 4px;
    }

    .pagination button.active {
        background: #4CAF50;
        color: white;
        border-color: #4CAF50;
    }

    .pagination button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* Preview Modal Styles */
    .preview-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        cursor: pointer;
    }

    .preview-content {
        position: relative;
        background: white;
        border-radius: 8px;
        padding: 4px;
        cursor: default;
    }

    .preview-close {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        font-size: 24px;
        cursor: pointer;
        z-index: 10;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .preview-close:hover {
        background: rgba(0, 0, 0, 0.9);
    }
</style>
{% endblock %}

{% block extra_scripts %}
<script>
let currentPage = 1;
let totalPages = 1;
let currentUser = null;

// Get current user info
async function getCurrentUser() {
    if (!token) return null;

    try {
        const response = await fetch('/api/me', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (response.ok) {
            return await response.json();
        }
    } catch (error) {
        console.error('Error getting current user:', error);
    }
    return null;
}

async function loadFiles(page = 1) {
    // Use the global token from base.html - DRY principle
    // Allow visitors to view files - no redirect if no token

    const searchInput = document.getElementById('searchInput').value;
    const myFilesOnly = document.getElementById('myFilesOnly').checked;

    const params = new URLSearchParams({
        page: page,
        per_page: 20
    });

    if (searchInput) params.append('search', searchInput);
    if (myFilesOnly) params.append('my_files_only', 'true');

    try {
        // Build headers - only include Authorization if we have a token
        const headers = {};
        if (token) {
            headers['Authorization'] = `Bearer ${token}`;
        }

        const response = await fetch(`/api/files?${params}`, { headers });

        if (!response.ok) {
            // Don't redirect visitors on 401, just show empty list
            if (response.status === 401 && !token) {
                // Visitor trying to access - show message
                document.getElementById('files-list').innerHTML = '<div class="loading">Please login to view files</div>';
                return;
            } else if (response.status === 401) {
                // User token expired
                localStorage.removeItem('token');
                window.location.href = '/login';
                return;
            }
            throw new Error('Failed to load files');
        }

        const data = await response.json();
        currentPage = data.page;
        totalPages = data.pages;

        displayFiles(data.files);
        updatePagination();
    } catch (error) {
        console.error('Error loading files:', error);
        document.getElementById('files-list').innerHTML = '<div class="loading">Error loading files</div>';
    }
}

function displayFiles(files) {
    const filesList = document.getElementById('files-list');

    if (files.length === 0) {
        filesList.innerHTML = '<div class="loading">No files found</div>';
        return;
    }

    filesList.innerHTML = files.map(file => {
        const isImage = file.content_type && file.content_type.startsWith('image/');
        const isPDF = file.content_type === 'application/pdf';
        const showPreview = isImage || isPDF;

        // Check if user can delete this file
        // Admin can delete any file, regular users can delete only their own files
        const canDelete = currentUser && (
            currentUser.role === 'admin' ||
            (file.uploaded_by && file.uploaded_by === currentUser.id)
        );

        return `
        <div class="flex flex-col sm:flex-row items-start sm:items-center p-4 border-b border-gray-200 hover:bg-gray-50 transition-colors duration-200">
            ${showPreview ? `
            <div class="flex-shrink-0 mb-3 sm:mb-0 sm:mr-4 w-20 h-20 flex items-center justify-center bg-gray-100 rounded-lg overflow-hidden">
                ${isImage && file.thumbnail_url ?
                    `<img src="${file.thumbnail_url}" alt="${file.original_filename}" onclick="openPreview('${file.download_url}', '${file.content_type}', '${file.original_filename}')" class="w-full h-full object-cover cursor-pointer hover:scale-105 transition-transform duration-200">`
                    : isImage ?
                    `<img src="${file.download_url}" alt="${file.original_filename}" onclick="openPreview('${file.download_url}', '${file.content_type}', '${file.original_filename}')" class="max-w-full max-h-full object-contain cursor-pointer hover:scale-105 transition-transform duration-200">`
                    : isPDF ?
                    `<div onclick="openPreview('${file.download_url}', '${file.content_type}', '${file.original_filename}')" class="cursor-pointer flex items-center justify-center w-full h-full">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M7 2C5.9 2 5 2.9 5 4V20C5 21.1 5.9 22 7 22H17C18.1 22 19 21.1 19 20V8L13 2H7Z" stroke="#dc3545" stroke-width="2"/>
                            <path d="M13 2V8H19" stroke="#dc3545" stroke-width="2"/>
                            <text x="12" y="16" text-anchor="middle" fill="#dc3545" font-size="6" font-weight="bold">PDF</text>
                        </svg>
                    </div>`
                    : ''}
            </div>
            ` : ''}
            <div class="flex-1 min-w-0 mb-3 sm:mb-0">
                <div class="font-medium text-gray-900 truncate">${file.original_filename}</div>
                <div class="text-sm text-gray-500 mt-1">
                    ${formatFileSize(file.file_size)} ·
                    ${file.uploaded_by_email || 'Unknown'} ·
                    ${new Date(file.created_at).toLocaleDateString()}
                </div>
            </div>
            <div class="flex flex-wrap gap-2">
                ${canDelete ? `<button onclick="deleteFile(${file.id})" class="px-3 py-1.5 text-xs bg-red-600 text-white rounded hover:bg-red-700 transition-colors duration-200">Delete</button>` : ''}
                <a href="${file.download_url}" class="px-3 py-1.5 text-xs bg-green-600 text-white rounded hover:bg-green-700 transition-colors duration-200" download>Download</a>
                <button onclick="copyLink('${file.download_url}')" class="px-3 py-1.5 text-xs bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors duration-200" title="Copy link to clipboard">Copy Link</button>
            </div>
        </div>
        `;
    }).join('');
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

function updatePagination() {
    const pagination = document.getElementById('pagination');
    let html = '';

    html += `<button onclick="loadFiles(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>Previous</button>`;

    for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
            html += `<button onclick="loadFiles(${i})" class="${i === currentPage ? 'active' : ''}">${i}</button>`;
        } else if (i === currentPage - 3 || i === currentPage + 3) {
            html += `<span>...</span>`;
        }
    }

    html += `<button onclick="loadFiles(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Next</button>`;

    pagination.innerHTML = html;
}

function openPreview(url, contentType, filename) {
    // Create modal for preview
    const modal = document.createElement('div');
    modal.className = 'preview-modal';
    modal.onclick = () => modal.remove();

    const content = document.createElement('div');
    content.className = 'preview-content';
    content.onclick = (e) => e.stopPropagation();

    if (contentType.startsWith('image/')) {
        const img = document.createElement('img');
        img.src = url;
        img.alt = filename;
        img.style.maxWidth = '90vw';
        img.style.maxHeight = '90vh';
        content.appendChild(img);
    } else if (contentType === 'application/pdf') {
        const iframe = document.createElement('iframe');
        iframe.src = url;
        iframe.style.width = '90vw';
        iframe.style.height = '90vh';
        iframe.style.border = 'none';
        content.appendChild(iframe);
    }

    // Add close button
    const closeBtn = document.createElement('button');
    closeBtn.className = 'preview-close';
    closeBtn.innerHTML = '×';
    closeBtn.onclick = () => modal.remove();
    content.appendChild(closeBtn);

    modal.appendChild(content);
    document.body.appendChild(modal);
}

function copyLink(downloadUrl) {
    // Construct the full URL
    const fullUrl = window.location.origin + downloadUrl;

    // Copy to clipboard
    navigator.clipboard.writeText(fullUrl).then(() => {
        // Show success feedback
        showCopyFeedback('Link copied to clipboard!');
    }).catch(err => {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = fullUrl;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        document.body.appendChild(textArea);
        textArea.select();
        try {
            document.execCommand('copy');
            showCopyFeedback('Link copied to clipboard!');
        } catch (err) {
            showCopyFeedback('Failed to copy link', true);
        }
        document.body.removeChild(textArea);
    });
}

function showCopyFeedback(message, isError = false) {
    // Create a toast notification
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 12px 20px;
        background: ${isError ? '#dc3545' : '#28a745'};
        color: white;
        border-radius: 4px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        z-index: 10000;
        animation: slideIn 0.3s ease;
    `;
    toast.textContent = message;

    // Add animation
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    `;
    document.head.appendChild(style);

    document.body.appendChild(toast);

    // Remove after 3 seconds
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease';
        toast.style.animationFillMode = 'forwards';
        setTimeout(() => {
            document.body.removeChild(toast);
            document.head.removeChild(style);
        }, 300);
    }, 3000);
}

async function deleteFile(fileId) {
    if (!confirm('Are you sure you want to delete this file?')) return;

    // Use the global token from base.html - DRY principle

    try {
        const response = await fetch(`/api/files/${fileId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (response.ok) {
            loadFiles(currentPage);
        } else {
            alert('Failed to delete file');
        }
    } catch (error) {
        console.error('Error deleting file:', error);
        alert('Error deleting file');
    }
}

// Setup event listeners
document.getElementById('searchInput').addEventListener('input', debounce(() => loadFiles(1), 500));
document.getElementById('myFilesOnly').addEventListener('change', () => loadFiles(1));

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Initialize on page load
async function init() {
    // Get current user info
    currentUser = await getCurrentUser();
    // Load files
    await loadFiles();
}

init();
</script>
{% endblock %}