{% extends "base.html" %}

{% block title %}Files - {{ project_name }}{% endblock %}

{% block content %}
<div class="files-container">
    <h2>Files</h2>

    <div class="filters">
        <input type="text" id="searchInput" placeholder="Search files..." class="search-input">
        <label>
            <input type="checkbox" id="myFilesOnly"> My files only
        </label>
    </div>

    <div id="files-list" class="files-list">
        <div class="loading">Loading files...</div>
    </div>

    <div class="pagination" id="pagination"></div>
</div>

<style>
    .files-container {
        max-width: 1200px;
        margin: 2rem auto;
        padding: 2rem;
    }

    .filters {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
        align-items: center;
    }

    .search-input {
        flex: 1;
        padding: 0.75rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 1rem;
    }

    .files-list {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        overflow: hidden;
    }

    .file-item {
        display: flex;
        align-items: center;
        padding: 1rem;
        border-bottom: 1px solid #eee;
        transition: background 0.2s;
    }

    .file-item:hover {
        background: #f8f9fa;
    }

    .file-info {
        flex: 1;
    }

    .file-name {
        font-weight: 500;
        color: #333;
        margin-bottom: 0.25rem;
    }

    .file-meta {
        font-size: 0.875rem;
        color: #666;
    }

    .file-actions {
        display: flex;
        gap: 0.5rem;
    }

    .btn-small {
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
    }

    .btn-download {
        background: #4CAF50;
        color: white;
    }

    .btn-delete {
        background: #dc3545;
        color: white;
    }

    .loading {
        text-align: center;
        padding: 2rem;
        color: #666;
    }

    .pagination {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        margin-top: 2rem;
    }

    .pagination button {
        padding: 0.5rem 1rem;
        border: 1px solid #ddd;
        background: white;
        cursor: pointer;
        border-radius: 4px;
    }

    .pagination button.active {
        background: #4CAF50;
        color: white;
        border-color: #4CAF50;
    }

    .pagination button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
</style>
{% endblock %}

{% block extra_scripts %}
<script>
let currentPage = 1;
let totalPages = 1;

async function loadFiles(page = 1) {
    const token = localStorage.getItem('token');
    if (!token) {
        window.location.href = '/login';
        return;
    }

    const searchInput = document.getElementById('searchInput').value;
    const myFilesOnly = document.getElementById('myFilesOnly').checked;

    const params = new URLSearchParams({
        page: page,
        per_page: 20
    });

    if (searchInput) params.append('search', searchInput);
    if (myFilesOnly) params.append('my_files_only', 'true');

    try {
        const response = await fetch(`/api/files?${params}`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (!response.ok) {
            if (response.status === 401) {
                localStorage.removeItem('token');
                window.location.href = '/login';
                return;
            }
            throw new Error('Failed to load files');
        }

        const data = await response.json();
        currentPage = data.page;
        totalPages = data.pages;

        displayFiles(data.files);
        updatePagination();
    } catch (error) {
        console.error('Error loading files:', error);
        document.getElementById('files-list').innerHTML = '<div class="loading">Error loading files</div>';
    }
}

function displayFiles(files) {
    const filesList = document.getElementById('files-list');

    if (files.length === 0) {
        filesList.innerHTML = '<div class="loading">No files found</div>';
        return;
    }

    filesList.innerHTML = files.map(file => `
        <div class="file-item">
            <div class="file-info">
                <div class="file-name">${file.original_filename}</div>
                <div class="file-meta">
                    ${formatFileSize(file.file_size)} ·
                    ${file.uploaded_by_email || 'Unknown'} ·
                    ${new Date(file.created_at).toLocaleDateString()}
                </div>
            </div>
            <div class="file-actions">
                <a href="${file.download_url}" class="btn-small btn-download" download>Download</a>
                ${file.can_delete !== false ? `<button onclick="deleteFile(${file.id})" class="btn-small btn-delete">Delete</button>` : ''}
            </div>
        </div>
    `).join('');
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

function updatePagination() {
    const pagination = document.getElementById('pagination');
    let html = '';

    html += `<button onclick="loadFiles(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>Previous</button>`;

    for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
            html += `<button onclick="loadFiles(${i})" class="${i === currentPage ? 'active' : ''}">${i}</button>`;
        } else if (i === currentPage - 3 || i === currentPage + 3) {
            html += `<span>...</span>`;
        }
    }

    html += `<button onclick="loadFiles(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Next</button>`;

    pagination.innerHTML = html;
}

async function deleteFile(fileId) {
    if (!confirm('Are you sure you want to delete this file?')) return;

    const token = localStorage.getItem('token');

    try {
        const response = await fetch(`/api/files/${fileId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (response.ok) {
            loadFiles(currentPage);
        } else {
            alert('Failed to delete file');
        }
    } catch (error) {
        console.error('Error deleting file:', error);
        alert('Error deleting file');
    }
}

// Setup event listeners
document.getElementById('searchInput').addEventListener('input', debounce(() => loadFiles(1), 500));
document.getElementById('myFilesOnly').addEventListener('change', () => loadFiles(1));

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Load files on page load
loadFiles();
</script>
{% endblock %}