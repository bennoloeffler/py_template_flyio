{% extends "base.html" %}

{% block title %}Upload - {{ project_name }}{% endblock %}

{% block content %}
<div class="upload-container">
    <h2>Upload Files</h2>

    <div class="upload-area" id="uploadArea">
        <div class="upload-icon">üìÅ</div>
        <p>Drag and drop files here or click to browse</p>
        <input type="file" id="fileInput" multiple style="display: none;">
        <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">Choose Files</button>
    </div>

    <div id="file-queue" class="file-queue"></div>

    <div id="upload-status" class="upload-status"></div>
</div>

<style>
    .upload-container {
        max-width: 800px;
        margin: 2rem auto;
        padding: 2rem;
    }

    .upload-area {
        border: 2px dashed #ddd;
        border-radius: 8px;
        padding: 3rem;
        text-align: center;
        background: white;
        transition: border-color 0.3s, background 0.3s;
        cursor: pointer;
    }

    .upload-area.dragover {
        border-color: #4CAF50;
        background: #f0f8ff;
    }

    .upload-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
    }

    .file-queue {
        margin-top: 2rem;
    }

    .file-item {
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 1rem;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
    }

    .file-item-info {
        flex: 1;
    }

    .file-item-name {
        font-weight: 500;
        margin-bottom: 0.25rem;
    }

    .file-item-size {
        font-size: 0.875rem;
        color: #666;
    }

    .file-item-status {
        margin-left: 1rem;
    }

    .progress-bar {
        width: 200px;
        height: 8px;
        background: #e0e0e0;
        border-radius: 4px;
        overflow: hidden;
    }

    .progress-bar-fill {
        height: 100%;
        background: #4CAF50;
        transition: width 0.3s;
    }

    .upload-status {
        margin-top: 2rem;
    }

    .status-message {
        padding: 1rem;
        border-radius: 4px;
        margin-bottom: 1rem;
    }

    .status-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .status-error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
</style>
{% endblock %}

{% block extra_scripts %}
<script>
const uploadArea = document.getElementById('uploadArea');
const fileInput = document.getElementById('fileInput');
const fileQueue = document.getElementById('file-queue');
const uploadStatus = document.getElementById('upload-status');

// Check authentication
const token = localStorage.getItem('token');
if (!token) {
    window.location.href = '/login';
}

// Drag and drop events
uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('dragover');
});

uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('dragover');
});

uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    handleFiles(e.dataTransfer.files);
});

// File input change
fileInput.addEventListener('change', (e) => {
    handleFiles(e.target.files);
});

function handleFiles(files) {
    for (let file of files) {
        uploadFile(file);
    }
}

async function uploadFile(file) {
    const fileId = Date.now() + Math.random();
    const fileItem = createFileItem(file, fileId);
    fileQueue.appendChild(fileItem);

    const formData = new FormData();
    formData.append('file', file);

    try {
        const response = await fetch('/api/files/upload', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`
            },
            body: formData
        });

        if (response.ok) {
            const data = await response.json();
            updateFileStatus(fileId, 'success', 'Uploaded successfully');
            showStatus(`Successfully uploaded: ${file.name}`, 'success');
        } else {
            const error = await response.json();
            updateFileStatus(fileId, 'error', error.detail || 'Upload failed');
            showStatus(`Failed to upload ${file.name}: ${error.detail}`, 'error');
        }
    } catch (error) {
        updateFileStatus(fileId, 'error', 'Network error');
        showStatus(`Failed to upload ${file.name}: Network error`, 'error');
    }
}

function createFileItem(file, fileId) {
    const div = document.createElement('div');
    div.className = 'file-item';
    div.id = `file-${fileId}`;
    div.innerHTML = `
        <div class="file-item-info">
            <div class="file-item-name">${file.name}</div>
            <div class="file-item-size">${formatFileSize(file.size)}</div>
        </div>
        <div class="file-item-status">
            <div class="progress-bar">
                <div class="progress-bar-fill" style="width: 50%"></div>
            </div>
        </div>
    `;
    return div;
}

function updateFileStatus(fileId, status, message) {
    const fileItem = document.getElementById(`file-${fileId}`);
    if (!fileItem) return;

    const statusDiv = fileItem.querySelector('.file-item-status');
    if (status === 'success') {
        statusDiv.innerHTML = '<span style="color: #4CAF50;">‚úì ' + message + '</span>';
    } else {
        statusDiv.innerHTML = '<span style="color: #dc3545;">‚úó ' + message + '</span>';
    }
}

function showStatus(message, type) {
    const div = document.createElement('div');
    div.className = `status-message status-${type}`;
    div.textContent = message;
    uploadStatus.appendChild(div);

    setTimeout(() => {
        div.remove();
    }, 5000);
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}
</script>
{% endblock %}