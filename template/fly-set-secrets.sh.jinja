#!/bin/bash
set -e

echo "========================================="
echo "üîê Fly.io Secrets Configuration Script"
echo "========================================="
echo ""

# Check if fly CLI is installed
if ! command -v fly &> /dev/null; then
    echo "‚ùå Fly CLI not found. Please install it first:"
    echo "   https://fly.io/docs/hands-on/install-flyctl/"
    exit 1
fi

# Check if logged in
if ! fly auth whoami &> /dev/null; then
    echo "‚ùå Not authenticated. Please run:"
    echo "   fly auth login"
    exit 1
fi

# Check if .env file exists
if [[ ! -f ".env" ]]; then
    echo "‚ùå .env file not found. Please create it first."
    exit 1
fi

# Step 1: Ask for environment (prod or test)
echo "üìã Select environment:"
echo "  1) Production"
echo "  2) Test/Staging"
echo ""
read -p "Enter choice [1-2]: " env_choice

case $env_choice in
    1)
        APP_NAME="{{ project_name }}"
        echo "‚úÖ Selected: Production (app: $APP_NAME)"
        ;;
    2)
        APP_NAME="{{ project_name }}-test"
        echo "‚úÖ Selected: Test/Staging (app: $APP_NAME)"
        ;;
    *)
        echo "‚ùå Invalid choice"
        exit 1
        ;;
esac

echo ""

# Check if app exists
if ! fly apps list | grep -q "^$APP_NAME"; then
    echo "‚ùå App '$APP_NAME' does not exist."
    echo ""
    echo "Available apps:"
    fly apps list
    echo ""
    read -p "Do you want to create '$APP_NAME'? [y/N]: " create_app
    if [[ $create_app =~ ^[Yy]$ ]]; then
        echo "Creating app '$APP_NAME'..."
        fly apps create "$APP_NAME"
    else
        exit 1
    fi
fi

echo ""
echo "üìù Loading .env file..."

# Source the .env file
set -a
source .env
set +a

echo "‚úÖ Loaded environment variables from .env"
echo ""

echo "========================================="
echo "üöÄ Setting secrets for $APP_NAME"
echo "========================================="
echo ""
echo "Setting secrets automatically from .env..."
echo ""

# Helper function to set a secret
set_secret() {
    local key=$1
    local value="${!key}"  # Indirect variable expansion

    if [[ -z "$value" ]]; then
        echo "‚è≠Ô∏è  Skipping $key (not set in .env)"
        return
    fi

    echo "Setting $key..."
    fly secrets set "$key=$value" --app "$APP_NAME"
    if [[ $? -eq 0 ]]; then
        echo "  ‚úÖ Set $key"
    else
        echo "  ‚ùå Failed to set $key"
    fi
    echo ""
}

# Set each secret explicitly
set_secret "SECRET_KEY"
set_secret "ADMIN_PASSWORD"
set_secret "DEFAULT_RATE_LIMIT"
set_secret "HEALTH_RATE_LIMIT"
set_secret "MAX_FILE_SIZE_MB"

echo ""
echo "========================================="
echo "üö¢ Deploying to activate secrets"
echo "========================================="
echo ""

fly deploy --app "$APP_NAME"

if [[ $? -eq 0 ]]; then
    echo ""
    echo "‚úÖ Deployment successful!"
    echo ""
    echo "üåê Your app is now live at:"
    echo "   https://${APP_NAME}.fly.dev"
else
    echo ""
    echo "‚ùå Deployment failed."
    exit 1
fi

echo ""
echo "========================================="
echo "‚úÖ Configuration complete!"
echo "========================================="
echo ""
